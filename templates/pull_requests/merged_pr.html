{% extends "layout.html" %}

{% block content %}


<div class="container-fluid">
    <h1 class="mt-2">
        {% if date_from and date_to %}
            {% set days_count = date_from | calculate_days_between_dates(date_to) %}
            {% if date_to_auto_set %}
                Merged Pull Requests from {{ date_from | format_date_display }} until today - {{ days_count }} day{{ 's' if days_count != 1 }} ({{ count }})
            {% else %}
                Merged Pull Requests: {{ date_from | format_date_display }} - {{ date_to | format_date_display }} - {{ days_count }} day{{ 's' if days_count != 1 }} ({{ count }})
            {% endif %}
        {% else %}
            Merged Pull Requests in last {{ merged_in_last_X_days }} days ({{ count }})
        {% endif %}
    </h1>
    <div class="mb-2">
        <div class="row align-items-start">
            <div class="col-auto">
                <button id="update_button" type="button" class="btn btn-outline-primary btn-sm"
                    data-url="merged?reload_data=1&days={{ merged_in_last_X_days }}{% if filter_username %}&username={{ filter_username }}{% endif %}{% if show_my_prs_only %}&my_prs=true{% endif %}{% if source_filter != 'both' %}&source={{ source_filter }}{% endif %}{% if organization_filter %}&organization={{ organization_filter }}{% endif %}">
                    Update Data
                </button>
            </div>
            <div class="col-auto">
                <div class="d-flex flex-column">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">From</span>
                        <input type="date" class="form-control" id="date-from-input"
                               value="{% if date_from %}{{ date_from }}{% endif %}" style="width: 140px;"
                               title="Start date (required)">
                        <span class="input-group-text">To</span>
                        <input type="date" class="form-control" id="date-to-input"
                               value="{% if date_to %}{{ date_to }}{% endif %}" style="width: 140px;"
                               title="End date (leave empty for 'until today')">
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="username-input" value="{{ filter_username }}"
                        placeholder="Filter by author" style="width: 120px;">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="apply-username">Filter</button>
                </div>
            </div>
            <div class="col-auto">
                <button class="btn {% if filter_username == 'konflux' %}btn-primary fw-bold{% else %}btn-outline-primary{% endif %} btn-sm" type="button" id="filter-konflux"
                        {% if filter_username == 'konflux' %}data-active="true" style="border: 2px solid #0d6efd;" {% endif %}
                        title="Filter by Konflux bot">
                    {% if filter_username == 'konflux' %}✓ {% endif %}{% if filter_username == 'konflux' %}<strong>Konflux</strong>{% else %}Konflux{% endif %}
                </button>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn {% if source_filter != 'both' %}btn-primary fw-bold{% else %}btn-outline-primary{% endif %} btn-sm dropdown-toggle" type="button" id="sourceDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                            {% if source_filter != 'both' %}style="border: 2px solid #0d6efd;"{% endif %}>
                        {% if source_filter != 'both' %}✓ {% endif %}
                        {% if source_filter == 'github' %}
                            <strong>GitHub Only</strong>
                        {% elif source_filter == 'gitlab' %}
                            <strong>GitLab Only</strong>
                        {% else %}
                            Source: Both
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="sourceDropdown">
                        <li><a class="dropdown-item small {% if source_filter == 'both' %}active{% endif %}" href="#" data-source="both"{% if source_filter == 'both' %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-git me-1"></i>Both (GitHub + GitLab)
                        </a></li>
                        <li><a class="dropdown-item small {% if source_filter == 'github' %}active{% endif %}" href="#" data-source="github"{% if source_filter == 'github' %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-github me-1"></i>GitHub Only
                        </a></li>
                        <li><a class="dropdown-item small {% if source_filter == 'gitlab' %}active{% endif %}" href="#" data-source="gitlab"{% if source_filter == 'gitlab' %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-gitlab me-1"></i>GitLab Only
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn {% if organization_filter %}btn-primary fw-bold{% else %}btn-outline-primary{% endif %} btn-sm dropdown-toggle" type="button" id="organizationDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                            {% if organization_filter %}style="border: 2px solid #0d6efd;"{% endif %}>
                        {% if organization_filter %}✓ {% endif %}
                        {% if organization_filter %}
                            <strong>{{ organization_filter }}</strong>
                        {% else %}
                            Organization: All
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="organizationDropdown">
                        <li><a class="dropdown-item small {% if not organization_filter %}active{% endif %}" href="#" data-organization=""{% if not organization_filter %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-building me-1"></i>All Organizations
                        </a></li>
                        {% for org in available_organizations %}
                        <li><a class="dropdown-item small {% if organization_filter == org %}active{% endif %}" href="#" data-organization="{{ org }}"{% if organization_filter == org %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-person-badge me-1"></i>{{ org }}
                        </a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% if github_username or gitlab_username %}
            <div class="col-auto">
                <button class="btn {% if show_my_prs_only %}btn-success fw-bold{% else %}btn-outline-success{% endif %} btn-sm" type="button" id="my-prs-toggle" {% if show_my_prs_only
                    %}data-active="true" style="border: 2px solid #198754;" {% endif %}
                    title="Filter by {% if github_username %}GitHub: {{ github_username }}{% endif %}{% if github_username and gitlab_username %}, {% endif %}{% if gitlab_username %}GitLab: {{ gitlab_username }}{% endif %}">
                    {% if show_my_prs_only %}✓ {% endif %}{% if show_my_prs_only %}<strong>My PRs</strong>{% else %}My PRs{% endif %}
                </button>
                <i class="bi bi-info-circle ms-1"
                   id="my-prs-config-info"
                   style="cursor: pointer; color: #6c757d; font-size: 0.875rem;"
                   title="Click for My PRs configuration info"></i>
            </div>
            {% endif %}
            <div class="col-auto">
                <button class="btn btn-outline-danger btn-sm" type="button" id="clear-filters">
                    Clear filters
                </button>
            </div>
        </div>
    </div>
    <div class="d-flex gap-4 mb-2">
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="labelsCheckbox" checked>
            <label class="form-check-label small" for="labelsCheckbox">Show Labels</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="viewToggleSwitch" checked>
            <label class="form-check-label small" for="viewToggleSwitch">Table View</label>
        </div>
    </div>

        {% if not github_merged_file_exists and not gitlab_merged_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>No data available.</strong>
            Click "Update Data" to download merged pull requests from GitHub and GitLab. This may take a while.
        </div>
    </div>
    {% elif not github_merged_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>GitHub merged PRs data missing.</strong>
            Click "Update Data" to download merged pull requests from GitHub. This may take a while.
        </div>
    </div>
    {% elif not gitlab_merged_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>GitLab merged MRs data missing.</strong>
            Click "Update Data" to download merged merge requests from GitLab. This may take a while.
        </div>
    </div>
    {% endif %}

    <hr>

    <div id="table_view" style="display: block;">
        <table id="datatable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Repository</th>
                    <th>PR/MR</th>
                    <th>Author</th>
                    <th class="dateTimeRenderColumn">Merged at</th>
                </tr>
            </thead>
            <tbody>
                {% for repo, prs in merged_pr_list.items() %}
                {% for pr in prs %}
                <tr>
                    <td>{{ repo }}</td>
                    <td>
                        <span class="labels">
                            {% if "[bot]" in pr.user_login.lower() or "konflux" in pr.user_login.lower() %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">bot</span>
                            {% endif %}
                        </span>
                        <a href="{{ pr.html_url }}" target="_blank">
                            {% if "github" in pr.html_url %}PR#{% else %}MR#{% endif %}{{ pr.number }}
                        </a>
                        {{ pr.title }}
                    </td>
                    <td>{{ pr.user_login }}</td>
                    <td>{{ pr.merged_at }}</td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="list_view" style="display: none;">
        {% for repo, prs in merged_pr_list | dictsort %}
        {% if prs %}
        <p style="font-weight: bold;">
            {{ repo.upper() }}
        </p>

        <ul id="pr_list">
            {% for pr in prs %}
            <li>
                <span class="labels">
                    {% if "[bot]" in pr.user_login.lower() or "konflux" in pr.user_login.lower() %}
                    <span class="badge text-bg-warning" style="font-size: 0.7rem;">bot</span>
                    {% endif %}
                </span>
                <a href="{{ pr.html_url }}" target="_blank">
                    {% if "github" in pr.html_url %}PR#{% else %}MR#{% endif %}{{ pr.number }}
                </a>
                <strong>{{ pr.title }}</strong>
                ({{ pr.user_login}})
                merged at {{ pr.merged_at | format_datetime }}
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        {% endfor %}
    </div>

</div>

<!-- Configuration Modal -->
{% include 'modals/my_prs_config_modal.html' %}

<!-- JavaScript -->
{% block js %}
<script type="application/javascript" src="{{ url_for('static', filename='js/datatable.js') }}"></script>
<script type="application/javascript" src="{{ url_for('static', filename='js/update_button.js') }}"></script>
<script type="application/javascript" src="{{ url_for('static', filename='js/pull_requests.js') }}"></script>
<script type="application/javascript" src="{{ url_for('static', filename='js/pr_filter_shared.js') }}"></script>
<script type="application/javascript" src="{{ url_for('static', filename='js/date_range_filter.js') }}"></script>
<script type="application/javascript" src="{{ url_for('static', filename='js/pr_config_modal.js') }}"></script>

<script>
// Source filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const sourceItems = document.querySelectorAll('#sourceDropdown + .dropdown-menu .dropdown-item');
    sourceItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove active class from all items
            sourceItems.forEach(i => i.classList.remove('active'));

            // Add active class to clicked item
            this.classList.add('active');

            // Update button appearance and text
            const dropdown = document.getElementById('sourceDropdown');
            const source = this.getAttribute('data-source');

            if (source === 'both') {
                dropdown.className = 'btn btn-outline-primary btn-sm dropdown-toggle';
                dropdown.style.border = '';
                dropdown.innerHTML = 'Source: Both';
            } else {
                dropdown.className = 'btn btn-primary fw-bold btn-sm dropdown-toggle';
                dropdown.style.border = '2px solid #0d6efd';
                if (source === 'github') {
                    dropdown.innerHTML = '✓ <strong>GitHub Only</strong>';
                } else if (source === 'gitlab') {
                    dropdown.innerHTML = '✓ <strong>GitLab Only</strong>';
                }
            }

            // Build URL with source filter
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('reload_data');

            if (source && source !== 'both') {
                urlParams.set('source', source);
            } else {
                urlParams.delete('source');
            }

            // Navigate to filtered URL
            const newUrl = urlParams.toString() ? `${window.location.pathname}?${urlParams.toString()}` : window.location.pathname;
            window.location.href = newUrl;
        });
    });
});

// Organization filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const organizationItems = document.querySelectorAll('#organizationDropdown + .dropdown-menu .dropdown-item');
    organizationItems.forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();

            // Remove active class from all items
            organizationItems.forEach(i => i.classList.remove('active'));

            // Add active class to clicked item
            this.classList.add('active');

            // Get selected organization
            const selectedOrganization = this.dataset.organization;

            // Get current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('reload_data');

            // Update organization parameter
            if (selectedOrganization === '' || selectedOrganization === null) {
                urlParams.delete('organization');
            } else {
                urlParams.set('organization', selectedOrganization);
            }

            // Navigate to updated URL
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.location.href = newUrl;
        });
    });
});

// Override clear filters to reset source and organization filters
document.addEventListener('DOMContentLoaded', function() {
    const clearFiltersBtn = document.getElementById('clear-filters');
    if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', function() {
            // Reset source dropdown to default state
            const sourceDropdown = document.getElementById('sourceDropdown');
            const sourceItems = document.querySelectorAll('#sourceDropdown + .dropdown-menu .dropdown-item');

            if (sourceDropdown && sourceItems.length > 0) {
                // Remove active class from all items
                sourceItems.forEach(item => item.classList.remove('active'));

                // Set "both" as active
                const bothItem = document.querySelector('#sourceDropdown + .dropdown-menu .dropdown-item[data-source="both"]');
                if (bothItem) {
                    bothItem.classList.add('active');
                }

                // Reset dropdown button appearance
                sourceDropdown.className = 'btn btn-outline-primary btn-sm dropdown-toggle';
                sourceDropdown.style.border = '';
                sourceDropdown.innerHTML = 'Source: Both';
            }

            // Reset organization dropdown to default state
            const orgDropdown = document.getElementById('organizationDropdown');
            const orgItems = document.querySelectorAll('#organizationDropdown + .dropdown-menu .dropdown-item');

            if (orgDropdown && orgItems.length > 0) {
                // Remove active class from all items
                orgItems.forEach(item => item.classList.remove('active'));

                // Set "all organizations" as active
                const allOrgItem = document.querySelector('#organizationDropdown + .dropdown-menu .dropdown-item[data-organization=""]');
                if (allOrgItem) {
                    allOrgItem.classList.add('active');
                }

                // Reset dropdown button appearance
                orgDropdown.className = 'btn btn-outline-primary btn-sm dropdown-toggle';
                orgDropdown.style.border = '';
                orgDropdown.innerHTML = 'Organization: All';
            }

            // Clear username input
            const usernameInput = document.getElementById('username-input');
            if (usernameInput) usernameInput.value = '';

            // Navigate to base URL without parameters
            window.location.href = window.location.pathname;
        });
    }
});

// Auto-apply date range filter
document.addEventListener('DOMContentLoaded', function() {
    const dateFromInput = document.getElementById('date-from-input');
    const dateToInput = document.getElementById('date-to-input');

    function applyDateFilter() {
        const dateFrom = dateFromInput ? dateFromInput.value : '';
        const dateTo = dateToInput ? dateToInput.value : '';

        // Only apply if we have a from date
        if (dateFrom) {
            const urlParams = new URLSearchParams(window.location.search);
            urlParams.delete('reload_data');

            // Set date range parameters
            urlParams.set('date_from', dateFrom);
            if (dateTo) {
                urlParams.set('date_to', dateTo);
            } else {
                urlParams.delete('date_to');
            }

            // Navigate to filtered URL
            const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.location.href = newUrl;
        }
    }

    if (dateFromInput) {
        dateFromInput.addEventListener('change', applyDateFilter);
    }
    if (dateToInput) {
        dateToInput.addEventListener('change', applyDateFilter);
    }
});

// View Toggle Switch functionality
document.addEventListener('DOMContentLoaded', function() {
    const viewToggleSwitch = document.getElementById('viewToggleSwitch');
    const tableView = document.getElementById('table_view');
    const listView = document.getElementById('list_view');
    const switchLabel = document.querySelector('label[for="viewToggleSwitch"]');

    if (viewToggleSwitch) {
        // Handle switch toggle
        viewToggleSwitch.addEventListener('change', function() {
            if (this.checked) {
                // Switch ON = Table View
                if (tableView) tableView.style.display = 'block';
                if (listView) listView.style.display = 'none';
                switchLabel.textContent = 'Table View';
            } else {
                // Switch OFF = List View
                if (tableView) tableView.style.display = 'none';
                if (listView) listView.style.display = 'block';
                switchLabel.textContent = 'List View';
            }
        });
    }
});
</script>
{% endblock %}

{% endblock %}
