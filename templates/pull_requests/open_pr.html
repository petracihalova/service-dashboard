{% extends "layout.html" %}

{% block content %}


<div class="container-fluid">
    <h1 class="mt-2">Open Pull Requests ({{ count }}) </h1>
    <div class="mb-2">
        <div class="row align-items-center">
            <div class="col-auto">
                <button id="update_button" type="button" class="btn btn-outline-primary btn-sm"
                        data-url="open?reload_data=1{% if filter_username %}&username={{ filter_username }}{% endif %}{% if show_my_prs_only %}&my_prs=true{% endif %}{% if source_filter != 'both' %}&source={{ source_filter }}{% endif %}{% if organization_filter %}&organization={{ organization_filter }}{% endif %}">
                    Update Data
                </button>
            </div>
            <div class="col-auto">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="username-input" value="{{ filter_username }}"
                           placeholder="Filter by author" style="width: 120px;">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="apply-username">Filter</button>
                </div>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn {% if source_filter != 'both' %}btn-primary fw-bold{% else %}btn-outline-primary{% endif %} btn-sm dropdown-toggle" type="button" id="sourceDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                            {% if source_filter != 'both' %}style="border: 2px solid #0d6efd;"{% endif %}>
                        {% if source_filter != 'both' %}✓ {% endif %}
                        {% if source_filter == 'github' %}
                            <strong>GitHub Only</strong>
                        {% elif source_filter == 'gitlab' %}
                            <strong>GitLab Only</strong>
                        {% else %}
                            Source: Both
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="sourceDropdown">
                        <li><a class="dropdown-item small {% if source_filter == 'both' %}active{% endif %}" href="#" data-source="both"{% if source_filter == 'both' %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-git me-1"></i>Both (GitHub + GitLab)
                        </a></li>
                        <li><a class="dropdown-item small {% if source_filter == 'github' %}active{% endif %}" href="#" data-source="github"{% if source_filter == 'github' %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-github me-1"></i>GitHub Only
                        </a></li>
                        <li><a class="dropdown-item small {% if source_filter == 'gitlab' %}active{% endif %}" href="#" data-source="gitlab"{% if source_filter == 'gitlab' %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-gitlab me-1"></i>GitLab Only
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn {% if organization_filter %}btn-primary fw-bold{% else %}btn-outline-primary{% endif %} btn-sm dropdown-toggle" type="button" id="organizationDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                            {% if organization_filter %}style="border: 2px solid #0d6efd;"{% endif %}>
                        {% if organization_filter %}✓ {% endif %}
                        {% if organization_filter %}
                            <strong>{{ organization_filter }}</strong>
                        {% else %}
                            Organization: All
                        {% endif %}
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="organizationDropdown">
                        <li><a class="dropdown-item small {% if not organization_filter %}active{% endif %}" href="#" data-organization=""{% if not organization_filter %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-building me-1"></i>All Organizations
                        </a></li>
                        {% for org in available_organizations %}
                        <li><a class="dropdown-item small {% if organization_filter == org %}active{% endif %}" href="#" data-organization="{{ org }}"{% if organization_filter == org %} style="background-color: #0d6efd !important; color: white !important;"{% endif %}>
                            <i class="bi bi-person-badge me-1"></i>{{ org }}
                        </a></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-auto">
                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="sizeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-bar-chart me-1"></i>Size: All
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="sizeDropdown">
                        <li><a class="dropdown-item small active" href="#" data-size="all">
                            <i class="bi bi-bar-chart me-1"></i>All Sizes
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item small" href="#" data-size="unknown">
                            <i class="bi bi-circle-fill me-1 text-secondary"></i>No Changes (0 lines)
                        </a></li>
                        <li><a class="dropdown-item small" href="#" data-size="small">
                            <i class="bi bi-circle-fill me-1 text-success"></i>Small (1-50 lines)
                        </a></li>
                        <li><a class="dropdown-item small" href="#" data-size="medium">
                            <i class="bi bi-circle-fill me-1 text-primary"></i>Medium (51-300 lines)
                        </a></li>
                        <li><a class="dropdown-item small" href="#" data-size="large">
                            <i class="bi bi-circle-fill me-1 text-warning"></i>Large (301-1000 lines)
                        </a></li>
                        <li><a class="dropdown-item small" href="#" data-size="huge">
                            <i class="bi bi-circle-fill me-1 text-danger"></i>Huge (1000+ lines)
                        </a></li>
                    </ul>
                </div>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-danger btn-sm" type="button" id="clear-filters">
                    Clear filters
                </button>
            </div>
        </div>
    </div>
    <div class="d-flex gap-4 mb-2">
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="labelsCheckbox" checked>
            <label class="form-check-label small" for="labelsCheckbox">Show Labels</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="viewToggleSwitch" checked>
            <label class="form-check-label small" for="viewToggleSwitch">Table View</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input filter-toggle" type="checkbox" role="switch" id="konfluxToggle"
                   {% if filter_username == 'konflux' %}checked{% endif %}>
            <label class="form-check-label small" for="konfluxToggle">Konflux Only</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input filter-toggle" type="checkbox" role="switch" id="nonKonfluxToggle"
                   {% if filter_username == 'non-konflux' %}checked{% endif %}>
            <label class="form-check-label small" for="nonKonfluxToggle">Non-Konflux Only</label>
        </div>
        {% if github_username or gitlab_username %}
        <div class="d-flex align-items-center">
            <div class="form-check form-switch form-check-sm">
                <input class="form-check-input filter-toggle" type="checkbox" role="switch" id="myPrsToggle"
                       {% if show_my_prs_only %}checked{% endif %}>
                <label class="form-check-label small" for="myPrsToggle">My PRs Only</label>
            </div>
            <i class="bi bi-info-circle ms-1"
               id="my-prs-config-info"
               style="cursor: pointer; color: #6c757d; font-size: 0.75rem;"
               title="Click for My PRs configuration info"></i>
        </div>
        {% endif %}
    </div>

        {% if not github_file_exists and not gitlab_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>No data available.</strong>
            Click "Update Data" to download pull requests from GitHub and GitLab. This may take a while.
        </div>
    </div>
    {% elif not github_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>GitHub open PRs data missing.</strong>
            Click "Update Data" to download open pull requests from GitHub. This may take a while.
        </div>
    </div>
    {% elif not gitlab_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>GitLab open MRs data missing.</strong>
            Click "Update Data" to download open merge requests from GitLab. This may take a while.
        </div>
    </div>
    {% endif %}

    <hr>

    <div id="table_view" style="display: block;">
        <table id="datatable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Repository</th>
                    <th>PR/MR</th>
                    <th>Author</th>
                    <th>Changes</th>
                    <th style="display: none;">Lines</th>
                    <th>Size</th>
                    <th class="dateTimeRenderColumn">Created at</th>
                </tr>
            </thead>
            <tbody>
                {% for repo, prs in open_pr_list.items() %}
                {% for pr in prs %}
                <tr>
                    <td>{{ repo }}</td>
                    <td>
                        <span class="labels">
                            {% if pr.draft or "draft" in pr.title.lower() %}
                            <span class="badge text-bg-secondary" style="font-size: 0.7rem;">draft</span>
                            {% endif %}

                            {% if "wip" in pr.title.lower() %}
                            <span class="badge text-bg-primary" style="font-size: 0.7rem;">wip</span>
                            {% endif %}

                            {% if "do not merge" in pr.title.lower() %}
                            <span class="badge text-bg-dark" style="font-size: 0.7rem;">not-merge</span>
                            {% endif %}

                            {% if "[bot]" in pr.user_login.lower() or "konflux" in pr.user_login.lower() %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">bot</span>
                            {% endif %}

                            {% if pr.created_at and is_older_than_six_months(pr.created_at) %}
                            <span class="badge text-bg-danger" style="font-size: 0.7rem;">older-6M</span>
                            {% endif %}

                            {% if pr.branch == "security-compliance" %}
                            <span class="badge text-bg-success" style="font-size: 0.7rem;">security-compliance</span>
                            {% endif %}

                        </span>

                        <a href="{{ pr.html_url }}" target="_blank">
                            {% if "github" in pr.html_url %}PR#{% else %}MR#{% endif %}{{ pr.number }}
                        </a>
                        {{ pr.title }}
                    </td>
                    <td>{{ pr.user_login }}</td>
                    <td>
                        {% if pr.additions is not none and pr.deletions is not none %}
                            <small class="text-success">+{{ pr.additions }}</small>
                            <small class="text-danger">-{{ pr.deletions }}</small>
                        {% else %}
                            <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td style="display: none;" data-size="{% if pr.additions is not none and pr.deletions is not none %}{{ pr.additions + pr.deletions }}{% else %}0{% endif %}">
                        {% if pr.additions is not none and pr.deletions is not none %}{{ pr.additions + pr.deletions }}{% else %}0{% endif %}
                    </td>
                    <td class="text-center">
                        {% if pr.additions is not none and pr.deletions is not none %}
                            {% set total_changes = pr.additions + pr.deletions %}
                            {% if total_changes == 0 %}
                                <span style="display: none;">No Changes</span><i class="bi bi-circle-fill text-secondary" title="No Changes (0 lines)"></i>
                            {% elif total_changes >= 1 and total_changes <= 50 %}
                                <span style="display: none;">Small</span><i class="bi bi-circle-fill text-success" title="Small ({{ total_changes }} lines)"></i>
                            {% elif total_changes >= 51 and total_changes <= 300 %}
                                <span style="display: none;">Medium</span><i class="bi bi-circle-fill text-primary" title="Medium ({{ total_changes }} lines)"></i>
                            {% elif total_changes >= 301 and total_changes <= 1000 %}
                                <span style="display: none;">Large</span><i class="bi bi-circle-fill text-warning" title="Large ({{ total_changes }} lines)"></i>
                            {% elif total_changes >= 1001 %}
                                <span style="display: none;">Huge</span><i class="bi bi-circle-fill text-danger" title="Huge ({{ total_changes }} lines)"></i>
                            {% else %}
                                <span style="display: none;">Unknown</span><i class="bi bi-circle-fill text-secondary" title="Unknown size"></i>
                            {% endif %}
                        {% else %}
                            <span style="display: none;">Unknown</span><i class="bi bi-circle-fill text-secondary" title="Unknown size"></i>
                        {% endif %}
                    </td>
                    <td>{{ pr.created_at | format_datetime }}</td>
                </tr>
                {% endfor %}
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="list_view" style="display: none;">
        {% for repo, prs in open_pr_list | dictsort %}
        {% if prs %}
        <p style="font-weight: bold;">
            {{ repo.upper() }}
        </p>

        <ul id="pr_list">
            {% for pr in prs %}
            <li data-size="{% if pr.additions is not none and pr.deletions is not none %}{{ pr.additions + pr.deletions }}{% else %}0{% endif %}">
                <span class="labels">
                    {% if pr.draft or "draft" in pr.title.lower() %}
                    <span class="badge text-bg-secondary" style="font-size: 0.7rem;">draft</span>
                    {% endif %}

                    {% if "wip" in pr.title.lower() %}
                    <span class="badge text-bg-primary" style="font-size: 0.7rem;">wip</span>
                    {% endif %}

                    {% if "do not merge" in pr.title.lower() %}
                    <span class="badge text-bg-dark" style="font-size: 0.7rem;">not-merge</span>
                    {% endif %}

                    {% if "[bot]" in pr.user_login.lower() or "konflux" in pr.user_login.lower() %}
                    <span class="badge text-bg-warning" style="font-size: 0.7rem;">bot</span>
                    {% endif %}

                    {% if pr.created_at and is_older_than_six_months(pr.created_at) %}
                    <span class="badge text-bg-danger" style="font-size: 0.7rem;">older-6M</span>
                    {% endif %}

                    {% if pr.branch == "security-compliance" %}
                    <span class="badge text-bg-success" style="font-size: 0.7rem;">security-compliance</span>
                    {% endif %}
                </span>
                <a href="{{ pr.html_url }}" target="_blank">
                    {% if "github" in pr.html_url %}PR#{% else %}MR#{% endif %}{{ pr.number }}
                </a>
                <strong>{{ pr.title }}</strong>
                ({{ pr.user_login}})
                from {{ pr.created_at | format_datetime }}
                {% if pr.additions is not none and pr.deletions is not none %}
                    - <small class="text-success">+{{ pr.additions }}</small> <small class="text-danger">-{{ pr.deletions }}</small>
                    {% set total_changes = pr.additions + pr.deletions %}
                    {% if total_changes == 0 %}
                        <span style="display: none;">No Changes</span> <i class="bi bi-circle-fill text-secondary" title="No Changes (0 lines)"></i>
                    {% elif total_changes >= 1 and total_changes <= 50 %}
                        <span style="display: none;">Small</span> <i class="bi bi-circle-fill text-success" title="Small ({{ total_changes }} lines)"></i>
                    {% elif total_changes >= 51 and total_changes <= 300 %}
                        <span style="display: none;">Medium</span> <i class="bi bi-circle-fill text-primary" title="Medium ({{ total_changes }} lines)"></i>
                    {% elif total_changes >= 301 and total_changes <= 1000 %}
                        <span style="display: none;">Large</span> <i class="bi bi-circle-fill text-warning" title="Large ({{ total_changes }} lines)"></i>
                    {% elif total_changes >= 1001 %}
                        <span style="display: none;">Huge</span> <i class="bi bi-circle-fill text-danger" title="Huge ({{ total_changes }} lines)"></i>
                    {% else %}
                        <span style="display: none;">Unknown</span> <i class="bi bi-circle-fill text-secondary" title="Unknown size"></i>
                    {% endif %}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
        {% endif %}

        {% endfor %}
    </div>
</div>

<!-- Configuration Modal -->
{% include 'modals/my_prs_config_modal.html' %}

<!-- JavaScript -->
{% block js %}
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/datatables/datatable.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/buttons/update-buttons.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/pages/pr-handlers/pull_requests.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/pr_filter_shared.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/modals/pr_config_modal.js') }}"></script>

    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/pr-filters.js') }}"></script>

{% endblock %}

{% endblock %}
