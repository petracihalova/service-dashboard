{% extends "layout.html" %}

{% block content %}

<!-- Column Filters Styling -->
<style>
.column-filter {
    margin-top: 8px;
    min-width: 120px;
}

.column-filter .form-select-sm,
.column-filter .form-control-sm {
    font-size: 0.775rem;
    padding: 0.25rem 0.5rem;
}

#datatable th {
    vertical-align: top;
    padding-bottom: 12px;
}

/* Ensure column filters don't interfere with sorting */
#datatable th .column-filter {
    margin-top: 5px;
}

#datatable th.sorting .column-filter,
#datatable th.sorting_asc .column-filter,
#datatable th.sorting_desc .column-filter {
    margin-top: 8px;
}

/* Add visual separation between sortable header text and filters */
#datatable th.sorting,
#datatable th.sorting_asc,
#datatable th.sorting_desc {
    cursor: pointer;
    border-bottom: 2px solid #dee2e6;
}

#datatable th.sorting:hover,
#datatable th.sorting_asc:hover,
#datatable th.sorting_desc:hover {
    background-color: #f8f9fa;
}

/* Ensure filter area doesn't change cursor */
#datatable th .column-filter {
    cursor: default;
}

/* Multi-select dropdown styling */
.multi-select-container {
    position: relative;
    width: 100%;
}

.multi-select-container .btn {
    font-size: 0.775rem;
    padding: 0.25rem 0.5rem;
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
}

.multi-select-container .dropdown-menu {
    font-size: 0.8rem;
    max-height: 250px;
    overflow-y: auto;
}

.multi-select-container .form-check {
    margin-bottom: 0.25rem;
}

.multi-select-container .form-check-label {
    font-size: 0.8rem;
    cursor: pointer;
    user-select: none;
}

/* Prevent dropdown from closing when clicking inside */
.multi-select-container .dropdown-menu {
    cursor: default;
}

.multi-select-container .dropdown-menu .form-check:hover {
    background-color: #f8f9fa;
    border-radius: 0.25rem;
}
</style>

<div class="container-fluid">
    <h1 class="mt-2">App-interface Closed MRs ({{ count }})</h1>
    <p class="text-muted mb-3">
        {% if date_from and date_to %}
            {% set days_count = date_from | calculate_days_between_dates(date_to) %}
            {% if date_to_auto_set %}
                {{ date_from | format_date_display }} until today - {{ days_count }} day{{ 's' if days_count != 1 }} | Only merge requests closed after {{ "2024-01-01" | format_date_display }}
            {% else %}
                {{ date_from | format_date_display }} - {{ date_to | format_date_display }} - {{ days_count }} day{{ 's' if days_count != 1 }} | Only merge requests closed after {{ "2024-01-01" | format_date_display }}
            {% endif %}
        {% else %}
            Last {{ closed_in_last_X_days }} days | Only merge requests closed after {{ "2024-01-01" | format_date_display }}
        {% endif %}
    </p>

    <p class="text-muted mb-2">
        Showing MRs from:
        {% if app_interface_users %}
            {{ app_interface_users | join(", ") }}
        {% else %}
            <em>No users configured (set APP_INTERFACE_USERS)</em>
        {% endif %}
        <i class="bi bi-info-circle ms-2"
           id="user-config-info"
           style="cursor: pointer; color: #6c757d;"
           title="Click for configuration info"></i>
    </p>
    <div class="mb-2">
        <div class="row align-items-start">
            <div class="col-auto">
                <button id="update_button" type="button" class="btn btn-outline-primary btn-sm"
                    data-url="app-interface-closed?reload_data=1&days={{ closed_in_last_X_days }}{% if filter_username %}&username={{ filter_username }}{% endif %}{% if show_my_mrs_only %}&my_mrs=true{% endif %}">
                    Update Data
                </button>
            </div>
            <div class="col-auto">
                <div class="d-flex flex-column">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">From</span>
                        <input type="date" class="form-control" id="date-from-input"
                               value="{% if date_from %}{{ date_from }}{% endif %}" style="width: 140px;"
                               title="Start date (required)">
                        <span class="input-group-text">To</span>
                        <input type="date" class="form-control" id="date-to-input"
                               value="{% if date_to %}{{ date_to }}{% endif %}" style="width: 140px;"
                               title="End date (leave empty for 'until today')">
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <div class="input-group input-group-sm">
                    <input type="text" class="form-control" id="username-input" value="{{ filter_username }}"
                        placeholder="Filter by author" style="width: 120px;">
                    <button class="btn btn-outline-primary btn-sm" type="button" id="apply-username">Filter</button>
                </div>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-danger btn-sm" type="button" id="clear-filters">
                    Clear filters
                </button>
            </div>
        </div>
    </div>
    <div class="d-flex gap-4 mb-2">
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="labelsCheckbox" checked>
            <label class="form-check-label small" for="labelsCheckbox">Show Labels</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="viewToggleSwitch" checked>
            <label class="form-check-label small" for="viewToggleSwitch">Table View</label>
        </div>
        {% if gitlab_username %}
        <div class="d-flex align-items-center">
            <div class="form-check form-switch form-check-sm">
                <input class="form-check-input filter-toggle" type="checkbox" role="switch" id="myPrsToggle"
                       {% if show_my_mrs_only %}checked{% endif %}>
                <label class="form-check-label small" for="myPrsToggle">My MRs Only</label>
            </div>
            <i class="bi bi-info-circle ms-1"
               id="gitlab-config-info"
               style="cursor: pointer; color: #6c757d; font-size: 0.75rem;"
               title="Click for GitLab username configuration info"></i>
        </div>
        {% endif %}
    </div>

    {% if not app_interface_closed_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>No data available.</strong>
            Click "Update Data" to download app-interface closed merge requests. This may take a while.
        </div>
    </div>
    {% endif %}

    <hr>

    <div id="table_view" style="display: block;">
        <table id="datatable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Repository</th>
                    <th>MR</th>
                    <th>Author</th>
                    <th>Changes</th>
                    <th style="display: none;">Lines</th>
                    <th>Size</th>
                    <th>Days Open</th>
                    <th class="dateTimeRenderColumn">Closed at</th>
                </tr>
            </thead>
            <tbody>
                {% for mr in closed_pr_list %}
                <tr>
                    <td>App-interface</td>
                    <td>
                        <span class="labels">
                            {% if "[bot]" in mr.user_login.lower() or "konflux" in mr.user_login.lower() %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">bot</span>
                            {% endif %}

                            {% if mr.merged_at %}
                            <span class="badge text-bg-success" style="font-size: 0.7rem;">merged</span>
                            {% endif %}
                        </span>
                        <a href="{{ mr.html_url }}" target="_blank">
                            MR#{{ mr.number }}
                        </a>
                        {{ mr.title }}
                    </td>
                    <td>{{ mr.user_login }}</td>
                    <td>
                        {% if mr.additions is not none and mr.deletions is not none %}
                            <small class="text-success">+{{ mr.additions }}</small>
                            <small class="text-danger">-{{ mr.deletions }}</small>
                        {% else %}
                            <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td style="display: none;" data-size="{% if mr.additions is not none and mr.deletions is not none %}{{ mr.additions + mr.deletions }}{% else %}0{% endif %}">
                        {% if mr.additions is not none and mr.deletions is not none %}{{ mr.additions + mr.deletions }}{% else %}0{% endif %}
                    </td>
                    <td class="text-center">
                        {% if mr.additions is not none and mr.deletions is not none %}
                            {% set total_changes = mr.additions + mr.deletions %}
                            {% if total_changes == 0 %}
                                <span style="display: none;">No Changes</span><i class="bi bi-circle-fill text-secondary" title="No Changes (0 lines)"></i>
                            {% elif total_changes >= 1 and total_changes <= 50 %}
                                <span style="display: none;">Small</span><i class="bi bi-circle-fill text-success" title="Small ({{ total_changes }} lines)"></i>
                            {% elif total_changes >= 51 and total_changes <= 300 %}
                                <span style="display: none;">Medium</span><i class="bi bi-circle-fill text-primary" title="Medium ({{ total_changes }} lines)"></i>
                            {% elif total_changes >= 301 and total_changes <= 1000 %}
                                <span style="display: none;">Large</span><i class="bi bi-circle-fill text-warning" title="Large ({{ total_changes }} lines)"></i>
                            {% elif total_changes >= 1001 %}
                                <span style="display: none;">Huge</span><i class="bi bi-circle-fill text-danger" title="Huge ({{ total_changes }} lines)"></i>
                            {% else %}
                                <span style="display: none;">Unknown</span><i class="bi bi-circle-fill text-secondary" title="Unknown size"></i>
                            {% endif %}
                        {% else %}
                            <span style="display: none;">Unknown</span><i class="bi bi-circle-fill text-secondary" title="Unknown size"></i>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        {% if mr.days_open is not none %}
                            {{ mr.days_open }}
                        {% else %}
                            <small class="text-muted">-</small>
                        {% endif %}
                    </td>
                    <td>{{ mr.closed_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="list_view" style="display: none;">
        <ul id="pr_list">
            {% for mr in closed_pr_list %}
            <li data-size="{% if mr.additions is not none and mr.deletions is not none %}{{ mr.additions + mr.deletions }}{% else %}0{% endif %}">
                <span class="labels">
                    {% if "[bot]" in mr.user_login.lower() or "konflux" in mr.user_login.lower() %}
                    <span class="badge text-bg-warning" style="font-size: 0.7rem;">bot</span>
                    {% endif %}

                    {% if mr.merged_at %}
                    <span class="badge text-bg-success" style="font-size: 0.7rem;">merged</span>
                    {% endif %}
                </span>
                <a href="{{ mr.html_url }}" target="_blank">
                    MR#{{ mr.number }}
                </a>
                <strong>{{ mr.title }}</strong>
                ({{ mr.user_login}})
                closed at {{ mr.closed_at | format_datetime }}
                {% if mr.days_open is not none %}
                    - opened for {{ mr.days_open }} day{{ 's' if mr.days_open != 1 }}
                {% endif %}
                {% if mr.additions is not none and mr.deletions is not none %}
                    - <small class="text-success">+{{ mr.additions }}</small> <small class="text-danger">-{{ mr.deletions }}</small>
                    {% set total_changes = mr.additions + mr.deletions %}
                    {% if total_changes == 0 %}
                        <span style="display: none;">No Changes</span> <i class="bi bi-circle-fill text-secondary" title="No Changes (0 lines)"></i>
                    {% elif total_changes >= 1 and total_changes <= 50 %}
                        <span style="display: none;">Small</span> <i class="bi bi-circle-fill text-success" title="Small ({{ total_changes }} lines)"></i>
                    {% elif total_changes >= 51 and total_changes <= 300 %}
                        <span style="display: none;">Medium</span> <i class="bi bi-circle-fill text-primary" title="Medium ({{ total_changes }} lines)"></i>
                    {% elif total_changes >= 301 and total_changes <= 1000 %}
                        <span style="display: none;">Large</span> <i class="bi bi-circle-fill text-warning" title="Large ({{ total_changes }} lines)"></i>
                    {% elif total_changes >= 1001 %}
                        <span style="display: none;">Huge</span> <i class="bi bi-circle-fill text-danger" title="Huge ({{ total_changes }} lines)"></i>
                    {% else %}
                        <span style="display: none;">Unknown</span> <i class="bi bi-circle-fill text-secondary" title="Unknown size"></i>
                    {% endif %}
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>

</div>

<!-- Configuration Modals -->
{% include 'modals/user_config_modal.html' %}
{% include 'modals/gitlab_config_modal.html' %}

<!-- JavaScript -->
{% block js %}
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/datatables/datatable.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/buttons/update-buttons.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/pages/pr-handlers/pull_requests.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/pr_filter_shared.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/date_range_filter.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/app_interface_filters.js') }}"></script>

    <script type="application/javascript" src="{{ url_for('static', filename='js/pages/pr-handlers/app-interface.js') }}"></script>

{% endblock %}

{% endblock %}
