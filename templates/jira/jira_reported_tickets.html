{% extends "layout.html" %}

{% block content %}

<div class="container-fluid">
    <h1 class="mt-2">Reported JIRA Tickets ({{ count }}) </h1>

    <p class="text-muted mb-2">
        Tickets reported by:
        {% if jira_config.current_user and jira_config.current_user != "Not available" and jira_config.current_user != "Unable to fetch user info" %}
            <strong>{{ jira_config.current_user }}</strong>
        {% else %}
            <em>JIRA user (configure JIRA_PERSONAL_ACCESS_TOKEN)</em>
        {% endif %}
        <i class="bi bi-info-circle ms-2"
           id="jira-config-info"
           style="cursor: pointer; color: #6c757d;"
           title="Click for JIRA configuration info"></i>
    </p>

    <div class="mb-2">
        <div class="row align-items-center">
            <div class="col-auto">
                <button id="update_button" type="button" class="btn btn-outline-primary btn-sm"
                        data-url="?reload_data=1">
                    Update Data
                </button>
            </div>
        </div>
    </div>
    <div class="d-flex gap-4 mb-2">
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="labelsCheckbox" checked>
            <label class="form-check-label small" for="labelsCheckbox">Show Labels</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="viewToggleSwitch" checked>
            <label class="form-check-label small" for="viewToggleSwitch">Table View</label>
        </div>
    </div>

    {% if not jira_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>No data available.</strong>
            Click "Update Data" to download JIRA tickets reported by you. This may take a while.
        </div>
    </div>
    {% endif %}

    <hr>

    <div id="table_view" style="display: block;">
        <table id="jira-reported-datatable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Key</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Assignee</th>
                    <th>Active Sprint</th>
                    <th class="dateTimeRenderColumn">Created at</th>
                    <th class="dateTimeRenderColumn">Updated at</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in jira_tickets %}
                <tr>
                    <td>{{ ticket.issue_type }}</td>
                    <td>
                        <a href="{{ ticket.url }}" target="_blank">{{ ticket.key }}</a>
                    </td>
                    <td>
                        <span class="labels">
                            {% if ticket.priority == 'Critical' %}
                            <span class="badge text-bg-danger" style="font-size: 0.7rem;">critical</span>
                            {% elif ticket.priority == 'High' %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">high</span>
                            {% elif ticket.priority == 'Medium' %}
                            <span class="badge text-bg-primary" style="font-size: 0.7rem;">medium</span>
                            {% elif ticket.priority == 'Low' %}
                            <span class="badge text-bg-secondary" style="font-size: 0.7rem;">low</span>
                            {% endif %}

                            {% for component in ticket.components %}
                            {% if 'management fabric' in component.lower() %}
                            <span class="badge text-bg-danger" style="font-size: 0.7rem;">{{ component }}</span>
                            {% elif 'security' in component.lower() %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">{{ component }}</span>
                            {% elif 'tech debt' in component.lower() %}
                            <span class="badge text-bg-secondary" style="font-size: 0.7rem;">{{ component }}</span>
                            {% else %}
                            <span class="badge text-bg-success" style="font-size: 0.7rem;">{{ component }}</span>
                            {% endif %}
                            {% endfor %}
                        </span>
                        {{ ticket.title }}
                    </td>
                    <td>{{ ticket.status }}</td>
                    <td>{{ ticket.priority }}</td>
                    <td>
                        {% if ticket.assignee != "Unassigned" %}
                            {{ ticket.assignee }}
                        {% endif %}
                    </td>
                    <td>
                        {% if ticket.in_active_sprint and ticket.sprint_name %}
                            {{ ticket.sprint_name }}
                        {% endif %}
                    </td>
                    <td>{{ ticket.created_at }}</td>
                    <td>{{ ticket.updated_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="list_view" style="display: none;">
        {% if jira_tickets %}
        <ul id="jira_ticket_list">
            {% for ticket in jira_tickets %}
            <li class="mb-3">
                <div>
                    <span class="labels">
                        {% if ticket.priority == 'Critical' %}
                        <span class="badge text-bg-danger" style="font-size: 0.7rem;">critical</span>
                        {% elif ticket.priority == 'High' %}
                        <span class="badge text-bg-warning" style="font-size: 0.7rem;">high</span>
                        {% elif ticket.priority == 'Medium' %}
                        <span class="badge text-bg-primary" style="font-size: 0.7rem;">medium</span>
                        {% elif ticket.priority == 'Low' %}
                        <span class="badge text-bg-secondary" style="font-size: 0.7rem;">low</span>
                        {% endif %}



                        {% for component in ticket.components %}
                        {% if 'management fabric' in component.lower() %}
                        <span class="badge text-bg-danger" style="font-size: 0.7rem;">{{ component }}</span>
                        {% elif 'security' in component.lower() %}
                        <span class="badge text-bg-warning" style="font-size: 0.7rem;">{{ component }}</span>
                        {% elif 'tech debt' in component.lower() %}
                        <span class="badge text-bg-secondary" style="font-size: 0.7rem;">{{ component }}</span>
                        {% else %}
                        <span class="badge text-bg-success" style="font-size: 0.7rem;">{{ component }}</span>
                        {% endif %}
                        {% endfor %}
                    </span>
                </div>
                <div>
                    <a href="{{ ticket.url }}" target="_blank">{{ ticket.key }}</a>
                    <strong>{{ ticket.title }}</strong>
                </div>
                <div class="text-muted">
                    <span>{{ ticket.issue_type }}</span> •
                    <span>Status: {{ ticket.status }}</span> •
                    <span>Priority: {{ ticket.priority }}</span> •
                    {% if ticket.assignee != "Unassigned" %}
                    <span>Assignee: {{ ticket.assignee }}</span> •
                    {% endif %}
                    {% if ticket.in_active_sprint and ticket.sprint_name %}
                        <span>Sprint: {{ ticket.sprint_name }}</span> •
                    {% endif %}
                    <span>Created {{ ticket.created_at | format_datetime }}</span>
                    {% if ticket.created_at != ticket.updated_at %}
                    • <span>Updated {{ ticket.updated_at | format_datetime }}</span>
                    {% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <div class="alert alert-info">
            No reported JIRA tickets found.
        </div>
        {% endif %}
    </div>
</div>

<!-- Configuration Modal -->
{% include 'modals/jira_config_modal.html' %}

<!-- JavaScript -->
{% block js %}
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/datatables/jira-datatables.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/buttons/update-buttons.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/utils/jira_tickets.js') }}"></script>

    <script>
        // Initialize JIRA reported tickets datatable
        JiraDataTables.initReported('#jira-reported-datatable');
    </script>
{% endblock %}

{% endblock %}
