{% extends "layout.html" %}

{% block content %}

<div class="container-fluid">
    <h1 class="mt-2">My Closed JIRA Tickets ({{ count }})</h1>
    <p class="text-muted mb-3">
        {% if date_from and date_to %}
            {% set days_count = date_from | calculate_days_between_dates(date_to) %}
            {% if date_to_auto_set %}
                {{ date_from | format_date_display }} until today - {{ days_count }} day{{ 's' if days_count != 1 }}
            {% else %}
                {{ date_from | format_date_display }} - {{ date_to | format_date_display }} - {{ days_count }} day{{ 's' if days_count != 1 }}
            {% endif %}
        {% else %}
            Only tickets resolved after {{ "2024-01-01" | format_date_display }}
        {% endif %}
    </p>

    <p class="text-muted mb-2">
        Tickets assigned to:
        {% if jira_config.current_user and jira_config.current_user != "Not available" and jira_config.current_user != "Unable to fetch user info" %}
            <strong>{{ jira_config.current_user }}</strong>
        {% else %}
            <em>JIRA user (configure JIRA_PERSONAL_ACCESS_TOKEN)</em>
        {% endif %}
        <i class="bi bi-info-circle ms-2"
           id="jira-config-info"
           style="cursor: pointer; color: #6c757d;"
           title="Click for JIRA configuration info"></i>
    </p>

    <div class="mb-2">
        <div class="row align-items-start">
            <div class="col-auto">
                <button id="update_button" type="button" class="btn btn-outline-primary btn-sm"
                        data-url="?reload_data=1&days={{ closed_in_last_X_days }}">
                    Update Data
                </button>
            </div>
            <div class="col-auto">
                <div class="d-flex flex-column">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">From</span>
                        <input type="date" class="form-control" id="date-from-input"
                               value="{% if date_from %}{{ date_from }}{% endif %}" style="width: 140px;"
                               title="Start date (required)">
                        <span class="input-group-text">To</span>
                        <input type="date" class="form-control" id="date-to-input"
                               value="{% if date_to %}{{ date_to }}{% endif %}" style="width: 140px;"
                               title="End date (leave empty for 'until today')">
                    </div>
                </div>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-danger btn-sm" type="button" id="clear-filters">
                    Clear filters
                </button>
            </div>
        </div>
    </div>
    <div class="d-flex gap-4 mb-2">
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="labelsCheckbox" checked>
            <label class="form-check-label small" for="labelsCheckbox">Show Labels</label>
        </div>
        <div class="form-check form-switch form-check-sm">
            <input class="form-check-input" type="checkbox" role="switch" id="viewToggleSwitch" checked>
            <label class="form-check-label small" for="viewToggleSwitch">Table View</label>
        </div>
    </div>

    {% if not jira_file_exists %}
    <div class="alert alert-warning d-flex align-items-center mt-3 mb-3" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <div>
            <strong>No data available.</strong> Click "Update Data" to download closed JIRA tickets resolved since January 1st, 2024. This may take a while.
        </div>
    </div>
    {% endif %}

    <hr>

    <!-- Table View -->
    <div id="table_view">
        <table id="jira-closed-datatable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Key</th>
                    <th>Title</th>
                    <th>Status</th>
                    <th>Resolution</th>
                    <th>Priority</th>
                    <th class="dateTimeRenderColumn">Resolved at</th>
                    <th class="dateTimeRenderColumn">Created at</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in jira_tickets %}
                <tr>
                    <td>{{ ticket.issue_type }}</td>
                    <td>
                        <a href="{{ ticket.url }}" target="_blank">{{ ticket.key }}</a>
                    </td>
                    <td>
                        <span class="labels">
                            {% if ticket.priority == 'Critical' %}
                            <span class="badge text-bg-danger" style="font-size: 0.7rem;">critical</span>
                            {% elif ticket.priority == 'High' %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">high</span>
                            {% elif ticket.priority == 'Medium' %}
                            <span class="badge text-bg-primary" style="font-size: 0.7rem;">medium</span>
                            {% elif ticket.priority == 'Low' %}
                            <span class="badge text-bg-secondary" style="font-size: 0.7rem;">low</span>
                            {% endif %}

                            {% for component in ticket.components %}
                            {% if 'management fabric' in component.lower() %}
                            <span class="badge text-bg-danger" style="font-size: 0.7rem;">{{ component }}</span>
                            {% elif 'security' in component.lower() %}
                            <span class="badge text-bg-warning" style="font-size: 0.7rem;">{{ component }}</span>
                            {% elif 'tech debt' in component.lower() %}
                            <span class="badge text-bg-secondary" style="font-size: 0.7rem;">{{ component }}</span>
                            {% else %}
                            <span class="badge text-bg-success" style="font-size: 0.7rem;">{{ component }}</span>
                            {% endif %}
                            {% endfor %}
                        </span>
                        {{ ticket.title }}
                    </td>
                    <td>{{ ticket.status }}</td>
                    <td>{{ ticket.resolution }}</td>
                    <td>{{ ticket.priority }}</td>
                    <td>{{ ticket.resolved_at }}</td>
                    <td>{{ ticket.created_at }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="list_view" style="display: none;">
        {% if jira_tickets %}
        <ul id="jira_closed_ticket_list">
            {% for ticket in jira_tickets %}
            <li class="mb-3">
                <div>
                    <span class="labels">
                        {% if ticket.priority == 'Critical' %}
                        <span class="badge text-bg-danger" style="font-size: 0.7rem;">critical</span>
                        {% elif ticket.priority == 'High' %}
                        <span class="badge text-bg-warning" style="font-size: 0.7rem;">high</span>
                        {% elif ticket.priority == 'Medium' %}
                        <span class="badge text-bg-primary" style="font-size: 0.7rem;">medium</span>
                        {% elif ticket.priority == 'Low' %}
                        <span class="badge text-bg-secondary" style="font-size: 0.7rem;">low</span>
                        {% endif %}



                        {% for component in ticket.components %}
                        {% if 'management fabric' in component.lower() %}
                        <span class="badge text-bg-danger" style="font-size: 0.7rem;">{{ component }}</span>
                        {% elif 'security' in component.lower() %}
                        <span class="badge text-bg-warning" style="font-size: 0.7rem;">{{ component }}</span>
                        {% elif 'tech debt' in component.lower() %}
                        <span class="badge text-bg-secondary" style="font-size: 0.7rem;">{{ component }}</span>
                        {% else %}
                        <span class="badge text-bg-success" style="font-size: 0.7rem;">{{ component }}</span>
                        {% endif %}
                        {% endfor %}
                    </span>
                </div>
                <div>
                    <a href="{{ ticket.url }}" target="_blank">{{ ticket.key }}</a>
                    <strong>{{ ticket.title }}</strong>
                </div>
                <div class="text-muted">
                    <span>{{ ticket.issue_type }}</span> •
                    <span>Status: {{ ticket.status }}</span> •
                    <span>Resolution: {{ ticket.resolution }}</span> •
                    <span>Priority: {{ ticket.priority }}</span> •
                    <span>Reporter: {{ ticket.reporter }}</span> •
                    <span>Created {{ ticket.created_at | format_datetime }}</span>
                    {% if ticket.created_at != ticket.updated_at %}
                    • <span>Updated {{ ticket.updated_at | format_datetime }}</span>
                    {% endif %}
                    {% if ticket.resolved_at %} • <span>Resolved {{ ticket.resolved_at | format_datetime }}</span>{% endif %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
            <p>No JIRA tickets to display.</p>
        {% endif %}
    </div>
</div>

{% endblock %}

<!-- Configuration Modal -->
{% include 'modals/jira_config_modal.html' %}

{% block js %}
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/datatables/jira-datatables.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/pr_filter_shared.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/filters/date_range_filter.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/components/buttons/update-buttons.js') }}"></script>
    <script type="application/javascript" src="{{ url_for('static', filename='js/utils/jira_tickets.js') }}"></script>

    <script>
        // Initialize JIRA closed tickets datatable
        JiraDataTables.initClosed('#jira-closed-datatable');
    </script>
{% endblock %}
