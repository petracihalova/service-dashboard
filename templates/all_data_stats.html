{% extends "layout.html" %}

{% block title %}All Data Statistics{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal_stats.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="mt-2">All Data Statistics </h1>
    </div>
    <p class="text-muted mb-4">
        {% if from_date and to_date %}
            {% set days_count = from_date | calculate_days_between_dates(to_date) %}
            {{ from_date | format_date_display }} - {{ to_date | format_date_display }} - {{ days_count }} day{{ 's' if days_count != 1 }}
        {% else %}
            Select a date range to view statistics
        {% endif %}
    </p>

    <!-- Date Range Filter Row -->
    <div class="row mb-4">
        <!-- Date Range Filter -->
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <i class="bi bi-calendar-range me-1"></i>Date Range
                    </h6>
                    <div class="d-flex flex-wrap align-items-end gap-3">
                        <div>
                            <label for="date-from-input" class="form-label small">From</label>
                            <input type="date" class="form-control form-control-sm" id="date-from-input"
                                   value="{{ from_date }}" title="Start date (required)">
                        </div>
                        <div>
                            <label for="date-to-input" class="form-label small">To</label>
                            <input type="date" class="form-control form-control-sm" id="date-to-input"
                                   value="{{ to_date }}" title="End date (leave empty for 'until today')">
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-danger btn-sm" id="clear-filters">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Clear filters
                            </button>
                        </div>
                    </div>

                    <!-- Quick Selection Dropdowns -->
                    <div class="mt-3">
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div>
                                <label for="quarter-select" class="form-label small mb-1">Quarter</label>
                                <select class="form-select form-select-sm" id="quarter-select" style="width: auto; min-width: 100px;">
                                    <option value="">Select...</option>
                                    <option value="all">All Quarters</option>
                                    <option value="q1">Q1 (Jan-Mar)</option>
                                    <option value="q2">Q2 (Apr-Jun)</option>
                                    <option value="q3">Q3 (Jul-Sep)</option>
                                    <option value="q4">Q4 (Oct-Dec)</option>
                                </select>
                            </div>
                            <div>
                                <label for="year-select" class="form-label small mb-1">Year</label>
                                <select class="form-select form-select-sm" id="year-select" style="width: auto; min-width: 80px;">
                                    <option value="">Select...</option>
                                    <!-- Years will be populated by JavaScript -->
                                </select>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">
                        <i class="bi bi-info-circle me-1"></i>All Data Overview
                    </h6>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people me-2" style="font-size: 1.1rem;"></i>
                            <div>
                                <strong>Scope:</strong>
                                <span class="text-muted ms-1">All users across all platforms</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-github me-2" style="font-size: 1.1rem;"></i>
                            <div>
                                <strong>GitHub:</strong>
                                <span class="text-muted ms-1">All Pull Requests</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-gitlab me-2" style="font-size: 1.1rem; color: #FC6D26;"></i>
                            <div>
                                <strong>GitLab:</strong>
                                <span class="text-muted ms-1">All Merge Requests</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-gear-fill me-2" style="font-size: 1.1rem; color: #0d6efd;"></i>
                            <div>
                                <strong>App-interface:</strong>
                                <span class="text-muted ms-1">All Merge Requests</span>
                                <i class="bi bi-info-circle ms-2"
                                   id="user-config-info-overview"
                                   style="cursor: pointer; color: #6c757d; font-size: 0.875rem;"
                                   title="Click for user list configuration info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Activity Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none text-start p-0 w-100 d-flex justify-content-between align-items-center"
                                type="button" data-bs-toggle="collapse" data-bs-target="#overallActivityCollapse"
                                aria-expanded="true" aria-controls="overallActivityCollapse">
                            <span>
                                <i class="bi bi-graph-up me-2 text-primary"></i>Overall Activity & Platform Statistics
                                <small class="text-muted ms-2">({{ overall_stats.github_total_prs + overall_stats.gitlab_total_mrs + overall_stats.app_interface_total_mrs }} total PRs/MRs)</small>
                            </span>
                            <i class="bi bi-chevron-down collapse-indicator"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="overallActivityCollapse">
                    <div class="card-body">

                        <!-- Overall Statistics Cards -->
                        <div class="row mb-4">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-primary-subtle border-primary">
                                    <div class="card-body text-center">
                                        <i class="bi bi-github text-primary" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-primary">{{ overall_stats.github_total_prs }}</h3>
                                        <p class="text-muted mb-0">GitHub PRs Total</p>
                                        <small class="text-muted">Merged + Closed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-success-subtle border-success">
                                    <div class="card-body text-center">
                                        <i class="bi bi-gitlab text-success" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-success">{{ overall_stats.gitlab_total_mrs }}</h3>
                                        <p class="text-muted mb-0">GitLab MRs Total</p>
                                        <small class="text-muted">Merged + Closed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-info-subtle border-info">
                                    <div class="card-body text-center">
                                        <i class="bi bi-gear-fill text-info" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-info">{{ overall_stats.app_interface_total_mrs }}</h3>
                                        <p class="text-muted mb-0">App-interface MRs Total</p>
                                        <small class="text-muted">Merged + Closed</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-warning-subtle border-warning">
                                    <div class="card-body text-center">
                                        <i class="bi bi-robot text-warning" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-warning">{{ overall_stats.konflux_prs_count }}</h3>
                                        <p class="text-muted mb-0">Konflux PRs</p>
                                        <small class="text-muted">Merged + Closed</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Breakdown -->
    <div class="row">
        <!-- GitHub Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-github me-2"></i>GitHub Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>PRs Merged:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.merged_pull_requests') }}?source=github&date_from={{ from_date }}&date_to={{ to_date }}"
                               class="text-decoration-none text-primary fw-bold">
                                {{ github_stats.merged_prs_count }}
                            </a>
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>PRs Closed:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.closed_pull_requests') }}?source=github&date_from={{ from_date }}&date_to={{ to_date }}"
                               class="text-decoration-none text-danger fw-bold">
                                {{ github_closed_stats.closed_prs_count }}
                            </a>
                        </strong>
                    </div>

                    <!-- Personal Repositories -->
                    {% if github_stats.personal_repos %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Personal repositories:</p>
                            {% for repo in github_stats.personal_repos %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>{{ repo }}</span>
                                    <small class="text-muted">{{ github_stats.personal_repo_stats.get(repo, 0) }} PRs</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Organization Repositories -->
                    {% if github_stats.organization_stats %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Organizations:</p>
                            {% for org_name, org_data in github_stats.organization_stats.items() %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <strong>{{ org_name }}</strong>
                                        <small class="text-muted">{{ org_data.pr_count }} PRs total</small>
                                    </div>
                                    <div class="ms-2">
                                        {% for repo in org_data.repos %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span>{{ repo }}</span>
                                                <small class="text-muted">{{ org_data.repo_stats.get(repo, 0) }} PRs</small>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                                                            <!-- User Statistics -->
                    {% if github_stats.user_stats or github_closed_stats.user_stats %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Most active users:</p>

                            <!-- Prepare final user stats list -->
                            {% if github_stats.user_stats and github_closed_stats.user_stats %}
                                <!-- Combined user stats from merged and closed PRs -->
                                {% set combined_user_stats = {} %}
                                {% for user, count in github_stats.user_stats %}
                                    {% set _ = combined_user_stats.update({user: combined_user_stats.get(user, 0) + count}) %}
                                {% endfor %}
                                {% for user, count in github_closed_stats.user_stats %}
                                    {% set _ = combined_user_stats.update({user: combined_user_stats.get(user, 0) + count}) %}
                                {% endfor %}
                                {% set final_user_stats = combined_user_stats.items() | sort(attribute=1, reverse=true) %}

                            {% elif github_stats.user_stats %}
                                {% set final_user_stats = github_stats.user_stats %}

                            {% elif github_closed_stats.user_stats %}
                                {% set final_user_stats = github_closed_stats.user_stats %}
                            {% endif %}

                                                        <!-- Show first 5 users -->
                            <div id="github-user-stats-preview">
                                {% for user, count in final_user_stats[:5] %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div>
                                            <span>{{ user }}</span>
                                            {% if "[bot]" in user.lower() or "konflux" in user.lower() %}
                                                <span class="badge text-bg-warning ms-1" style="font-size: 0.6rem;">bot</span>
                                            {% endif %}
                                            {% if github_username and user.lower() == github_username.lower() %}
                                                <span class="badge text-bg-primary ms-1" style="font-size: 0.6rem;">you</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ count }} PRs</small>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Hidden section with remaining users -->
                            {% if final_user_stats | length > 5 %}
                                <div id="github-user-stats-full" style="display: none;">
                                    {% for user, count in final_user_stats[5:] %}
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <div>
                                                <span>{{ user }}</span>
                                                {% if "[bot]" in user.lower() or "konflux" in user.lower() %}
                                                    <span class="badge text-bg-warning ms-1" style="font-size: 0.6rem;">bot</span>
                                                {% endif %}
                                                {% if github_username and user.lower() == github_username.lower() %}
                                                    <span class="badge text-bg-primary ms-1" style="font-size: 0.6rem;">you</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">{{ count }} PRs</small>
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- Toggle button -->
                                <div class="text-center mt-2">
                                    <button class="btn btn-link btn-sm p-0 text-primary" id="github-user-stats-toggle" style="font-size: 0.8rem;">
                                        <i class="bi bi-chevron-down me-1"></i>Show {{ (final_user_stats | length) - 5 }} more...
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if github_stats.merged_prs_count == 0 and github_closed_stats.closed_prs_count == 0 %}
                        <p class="text-muted small">No GitHub activity in this date range</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- GitLab Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-gitlab me-2" style="color: #FC6D26;"></i>GitLab Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>MRs Merged:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.merged_pull_requests') }}?source=gitlab&date_from={{ from_date }}&date_to={{ to_date }}"
                               class="text-decoration-none text-primary fw-bold">
                                {{ gitlab_stats.merged_prs_count }}
                            </a>
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>MRs Closed:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.closed_pull_requests') }}?source=gitlab&date_from={{ from_date }}&date_to={{ to_date }}"
                               class="text-decoration-none text-danger fw-bold">
                                {{ gitlab_closed_stats.closed_prs_count }}
                            </a>
                        </strong>
                    </div>

                    <!-- Personal Repositories -->
                    {% if gitlab_stats.personal_repos %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Personal repositories:</p>
                            {% for repo in gitlab_stats.personal_repos %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>{{ repo }}</span>
                                    <small class="text-muted">{{ gitlab_stats.personal_repo_stats.get(repo, 0) }} MRs</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Organization Repositories -->
                    {% if gitlab_stats.organization_stats %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Organizations:</p>
                            {% for org_name, org_data in gitlab_stats.organization_stats.items() %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <strong>{{ org_name }}</strong>
                                        <small class="text-muted">{{ org_data.pr_count }} MRs total</small>
                                    </div>
                                    <div class="ms-2">
                                        {% for repo in org_data.repos %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span>{{ repo }}</span>
                                                <small class="text-muted">{{ org_data.repo_stats.get(repo, 0) }} MRs</small>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- User Statistics -->
                    {% if gitlab_stats.user_stats or gitlab_closed_stats.user_stats %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Most active users:</p>

                            <!-- Prepare final user stats list -->
                            {% if gitlab_stats.user_stats and gitlab_closed_stats.user_stats %}
                                <!-- Combined user stats from merged and closed MRs -->
                                {% set combined_user_stats = {} %}
                                {% for user, count in gitlab_stats.user_stats %}
                                    {% set _ = combined_user_stats.update({user: combined_user_stats.get(user, 0) + count}) %}
                                {% endfor %}
                                {% for user, count in gitlab_closed_stats.user_stats %}
                                    {% set _ = combined_user_stats.update({user: combined_user_stats.get(user, 0) + count}) %}
                                {% endfor %}
                                {% set final_gitlab_user_stats = combined_user_stats.items() | sort(attribute=1, reverse=true) %}

                            {% elif gitlab_stats.user_stats %}
                                {% set final_gitlab_user_stats = gitlab_stats.user_stats %}

                            {% elif gitlab_closed_stats.user_stats %}
                                {% set final_gitlab_user_stats = gitlab_closed_stats.user_stats %}
                            {% endif %}

                            <!-- Show first 5 users -->
                            <div id="gitlab-user-stats-preview">
                                {% for user, count in final_gitlab_user_stats[:5] %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div>
                                            <span>{{ user }}</span>
                                            {% if "[bot]" in user.lower() or "konflux" in user.lower() %}
                                                <span class="badge text-bg-warning ms-1" style="font-size: 0.6rem;">bot</span>
                                            {% endif %}
                                            {% if gitlab_username and user.lower() == gitlab_username.lower() %}
                                                <span class="badge text-bg-success ms-1" style="font-size: 0.6rem;">you</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ count }} MRs</small>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Hidden section with remaining users -->
                            {% if final_gitlab_user_stats | length > 5 %}
                                <div id="gitlab-user-stats-full" style="display: none;">
                                    {% for user, count in final_gitlab_user_stats[5:] %}
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <div>
                                                <span>{{ user }}</span>
                                                {% if "[bot]" in user.lower() or "konflux" in user.lower() %}
                                                    <span class="badge text-bg-warning ms-1" style="font-size: 0.6rem;">bot</span>
                                                {% endif %}
                                                {% if gitlab_username and user.lower() == gitlab_username.lower() %}
                                                    <span class="badge text-bg-success ms-1" style="font-size: 0.6rem;">you</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">{{ count }} MRs</small>
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- Toggle button -->
                                <div class="text-center mt-2">
                                    <button class="btn btn-link btn-sm p-0 text-primary" id="gitlab-user-stats-toggle" style="font-size: 0.8rem;">
                                        <i class="bi bi-chevron-down me-1"></i>Show {{ (final_gitlab_user_stats | length) - 5 }} more...
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if gitlab_stats.merged_prs_count == 0 and gitlab_closed_stats.closed_prs_count == 0 %}
                        <p class="text-muted small">No GitLab activity in this date range</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- App-interface Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-gear-fill me-2" style="color: #0d6efd;"></i>App-interface Activity
                        <i class="bi bi-info-circle ms-2"
                           id="user-config-info"
                           style="cursor: pointer; color: #6c757d; font-size: 0.875rem;"
                           title="Click for user list configuration info"></i>
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>MRs Merged:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.app_interface_merged_merge_requests') }}?date_from={{ from_date }}&date_to={{ to_date }}"
                               class="text-decoration-none text-primary fw-bold">
                                {{ app_interface_stats.merged_prs_count }}
                            </a>
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>MRs Closed:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.app_interface_closed_merge_requests') }}?date_from={{ from_date }}&date_to={{ to_date }}"
                               class="text-decoration-none text-danger fw-bold">
                                {{ app_interface_closed_stats.closed_prs_count }}
                            </a>
                        </strong>
                    </div>

                    <!-- App-interface Repository -->
                    {% if app_interface_stats.personal_repos %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Repository:</p>
                            {% for repo in app_interface_stats.personal_repos %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>{{ repo }}</span>
                                    <small class="text-muted">{{ app_interface_stats.personal_repo_stats.get(repo, 0) }} MRs</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- User Statistics -->
                    {% if app_interface_stats.user_stats or app_interface_closed_stats.user_stats %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Most active users:</p>

                            <!-- Prepare final user stats list -->
                            {% if app_interface_stats.user_stats and app_interface_closed_stats.user_stats %}
                                <!-- Combined user stats from merged and closed MRs -->
                                {% set combined_user_stats = {} %}
                                {% for user, count in app_interface_stats.user_stats %}
                                    {% set _ = combined_user_stats.update({user: combined_user_stats.get(user, 0) + count}) %}
                                {% endfor %}
                                {% for user, count in app_interface_closed_stats.user_stats %}
                                    {% set _ = combined_user_stats.update({user: combined_user_stats.get(user, 0) + count}) %}
                                {% endfor %}
                                {% set final_app_interface_user_stats = combined_user_stats.items() | sort(attribute=1, reverse=true) %}

                            {% elif app_interface_stats.user_stats %}
                                {% set final_app_interface_user_stats = app_interface_stats.user_stats %}

                            {% elif app_interface_closed_stats.user_stats %}
                                {% set final_app_interface_user_stats = app_interface_closed_stats.user_stats %}
                            {% endif %}

                            <!-- Show first 5 users -->
                            <div id="app-interface-user-stats-preview">
                                {% for user, count in final_app_interface_user_stats[:5] %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div>
                                            <span>{{ user }}</span>
                                            {% if "[bot]" in user.lower() or "konflux" in user.lower() %}
                                                <span class="badge text-bg-warning ms-1" style="font-size: 0.6rem;">bot</span>
                                            {% endif %}
                                            {% if (github_username and user.lower() == github_username.lower()) or (gitlab_username and user.lower() == gitlab_username.lower()) %}
                                                <span class="badge text-bg-info ms-1" style="font-size: 0.6rem;">you</span>
                                            {% endif %}
                                        </div>
                                        <small class="text-muted">{{ count }} MRs</small>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Hidden section with remaining users -->
                            {% if final_app_interface_user_stats | length > 5 %}
                                <div id="app-interface-user-stats-full" style="display: none;">
                                    {% for user, count in final_app_interface_user_stats[5:] %}
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <div>
                                                <span>{{ user }}</span>
                                                {% if "[bot]" in user.lower() or "konflux" in user.lower() %}
                                                    <span class="badge text-bg-warning ms-1" style="font-size: 0.6rem;">bot</span>
                                                {% endif %}
                                                {% if (github_username and user.lower() == github_username.lower()) or (gitlab_username and user.lower() == gitlab_username.lower()) %}
                                                    <span class="badge text-bg-info ms-1" style="font-size: 0.6rem;">you</span>
                                                {% endif %}
                                            </div>
                                            <small class="text-muted">{{ count }} MRs</small>
                                        </div>
                                    {% endfor %}
                                </div>

                                <!-- Toggle button -->
                                <div class="text-center mt-2">
                                    <button class="btn btn-link btn-sm p-0 text-primary" id="app-interface-user-stats-toggle" style="font-size: 0.8rem;">
                                        <i class="bi bi-chevron-down me-1"></i>Show {{ (final_app_interface_user_stats | length) - 5 }} more...
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                    {% if app_interface_stats.merged_prs_count == 0 and app_interface_closed_stats.closed_prs_count == 0 %}
                        <p class="text-muted small">No app-interface activity in this date range</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Konflux GitHub Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-robot me-2" style="color: #0d6efd;"></i>Konflux GitHub Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>PRs Merged:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.merged_pull_requests') }}?source=github&date_from={{ from_date }}&date_to={{ to_date }}&username=konflux"
                               class="text-decoration-none text-primary fw-bold">
                                {{ github_konflux_stats.merged_prs_count }}
                            </a>
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span>PRs Closed:</span>
                        <strong>
                            <a href="{{ url_for('pull_requests.closed_pull_requests') }}?source=github&date_from={{ from_date }}&date_to={{ to_date }}&username=konflux"
                               class="text-decoration-none text-danger fw-bold">
                                {{ github_konflux_closed_stats.closed_prs_count }}
                            </a>
                        </strong>
                    </div>

                    <!-- Personal Repositories -->
                    {% if github_konflux_stats.personal_repos %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Personal repositories:</p>
                            {% for repo in github_konflux_stats.personal_repos %}
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span>{{ repo }}</span>
                                    <small class="text-muted">{{ github_konflux_stats.personal_repo_stats.get(repo, 0) }} PRs</small>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <!-- Organization Repositories -->
                    {% if github_konflux_stats.organization_stats %}
                        <div class="mb-3">
                            <p class="small text-muted mb-2">Organizations:</p>
                            {% for org_name, org_data in github_konflux_stats.organization_stats.items() %}
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <strong>{{ org_name }}</strong>
                                        <small class="text-muted">{{ org_data.pr_count }} PRs total</small>
                                    </div>
                                    <div class="ms-2">
                                        {% for repo in org_data.repos %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span>{{ repo }}</span>
                                                <small class="text-muted">{{ org_data.repo_stats.get(repo, 0) }} PRs</small>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    {% if github_konflux_stats.merged_prs_count == 0 and github_konflux_closed_stats.closed_prs_count == 0 %}
                        <p class="text-muted small">No Konflux GitHub activity in this date range</p>
                    {% endif %}
                </div>
            </div>
        </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Code Impact & Diff Statistics Section -->
    {% if diff_stats.total_count > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <button class="btn btn-link text-decoration-none text-start p-0 w-100 d-flex justify-content-between align-items-center"
                                type="button" data-bs-toggle="collapse" data-bs-target="#allDataCodeStatsCollapse"
                                aria-expanded="true" aria-controls="allDataCodeStatsCollapse">
                            <span>
                                <i class="bi bi-code-slash me-2 text-success"></i>Code Impact & Diff Statistics
                                <span class="badge bg-success ms-2">Merged Only</span>
                                <small class="text-muted ms-2">
                                    ({{ diff_stats.total_count }} merged PRs/MRs with diff data from all users
                                    {% if diff_stats.excluded_count > 0 %}
                                        • {{ diff_stats.excluded_count }} excluded due to missing data
                                    {% endif %})
                                </small>
                            </span>
                            <i class="bi bi-chevron-down collapse-indicator"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="allDataCodeStatsCollapse">
                    <div class="card-body">

                        <!-- Code Stats Filters - Always visible -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div id="allDataCodeStatsFilters" class="bg-light rounded p-3">
                                    <!-- Filter Header -->
                                    <div class="d-flex align-items-center gap-2 mb-3">
                                        <i class="bi bi-funnel text-muted"></i>
                                        <span class="text-muted small fw-semibold">Filters:</span>
                                    </div>

                                    <!-- Row 1: Source Filters -->
                                    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                                        <span class="text-muted small">Source:</span>

                                        <!-- GitHub Only Toggle -->
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input bg-success border-success" type="checkbox"
                                                       role="switch" id="allDataGithubOnlyToggle">
                                                <label class="form-check-label small text-success fw-semibold" for="allDataGithubOnlyToggle">
                                                    <i class="bi bi-github me-1"></i>GitHub PRs
                                                </label>
                                            </div>
                                        </div>

                                        <!-- GitLab Only Toggle -->
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input bg-warning border-warning" type="checkbox"
                                                       role="switch" id="allDataGitlabOnlyToggle">
                                                <label class="form-check-label small text-warning fw-semibold" for="allDataGitlabOnlyToggle">
                                                    <i class="bi bi-gitlab me-1"></i>GitLab MRs
                                                </label>
                                            </div>
                                        </div>

                                        <!-- App-interface Only Toggle -->
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input bg-info border-info" type="checkbox"
                                                       role="switch" id="allDataAppInterfaceOnlyToggle">
                                                <label class="form-check-label small text-info fw-semibold" for="allDataAppInterfaceOnlyToggle">
                                                    <i class="bi bi-gear-fill me-1"></i>App-interface
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Row 2: Repository Filters -->
                                    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                                        <span class="text-muted small">Repository Scope:</span>

                                        <!-- Without Personal Repos Toggle -->
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input bg-secondary border-secondary" type="checkbox"
                                                       role="switch" id="allDataWithoutPersonalToggle">
                                                <label class="form-check-label small text-secondary fw-semibold" for="allDataWithoutPersonalToggle">
                                                    <i class="bi bi-building me-1"></i>Without Personal Repos
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Row 3: User Type Filters -->
                                    <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
                                        <span class="text-muted small">User Type:</span>

                                        <!-- Konflux Only Toggle -->
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input bg-primary border-primary" type="checkbox"
                                                       role="switch" id="allDataKonfluxOnlyToggle">
                                                <label class="form-check-label small text-primary fw-semibold" for="allDataKonfluxOnlyToggle">
                                                    <i class="bi bi-robot me-1"></i>Konflux Only
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Non-Konflux Only Toggle -->
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="form-check form-switch mb-0">
                                                <input class="form-check-input bg-dark border-dark" type="checkbox"
                                                       role="switch" id="allDataNonKonfluxOnlyToggle">
                                                <label class="form-check-label small text-dark fw-semibold" for="allDataNonKonfluxOnlyToggle">
                                                    <i class="bi bi-person me-1"></i>Non-Konflux Only
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Clear Filters Button -->
                                    <div class="d-flex justify-content-end">
                                        <button type="button" class="btn btn-outline-secondary btn-sm" id="allDataClearCodeStatsFilters">
                                            <i class="bi bi-arrow-counterclockwise me-1"></i>Clear All Filters
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Statistics Content -->
                        <!-- Summary Cards Row -->
                        <div class="row mb-4">
                            <!-- Total Additions -->
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-success-subtle border-success h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-plus-circle text-success" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-success">{{ '{:,}'.format(diff_stats.total_additions) }}</h3>
                                        <p class="text-muted mb-0">Total Additions</p>
                                        <small class="text-muted">Lines added across all merged PRs/MRs</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Total Deletions -->
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-danger-subtle border-danger h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-dash-circle text-danger" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-danger">{{ '{:,}'.format(diff_stats.total_deletions) }}</h3>
                                        <p class="text-muted mb-0">Total Deletions</p>
                                        <small class="text-muted">Lines removed across all merged PRs/MRs</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Net Change -->
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-info-subtle border-info h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-graph-{{ 'up' if diff_stats.total_net_changes >= 0 else 'down' }} text-info" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-info">{{ '{:,}'.format(diff_stats.total_net_changes) }}</h3>
                                        <p class="text-muted mb-0">Net Change</p>
                                        <small class="text-muted">Total additions minus deletions</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Files Changed -->
                            <div class="col-lg-3 col-md-6 mb-3">
                                <div class="card bg-warning-subtle border-warning h-100">
                                    <div class="card-body text-center">
                                        <i class="bi bi-file-text text-warning" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-1 text-warning">{{ '{:,}'.format(diff_stats.total_files_changed) }}</h3>
                                        <p class="text-muted mb-0">Files Changed</p>
                                        <small class="text-muted">Total files modified across all merged PRs/MRs</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PR/MR Size Distribution -->
                        <div class="row mb-4">
                            <div class="col-6">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-bar-chart me-1"></i>PR/MR Size Distribution
                                </h6>
                                <!-- Size distribution cards with proportional heights -->
                                <div class="row align-items-end" style="min-height: 180px;">
                                    <!-- Small Card -->
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <div class="d-flex justify-content-between align-items-end p-2 bg-success-subtle rounded"
                                             style="min-height: {{ 60 + (diff_stats.size_percentages.small|default(0) * 2) }}px;">
                                            <div>
                                                <strong class="text-success">Small</strong>
                                                <br><small class="text-muted">1-50 lines</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-success">{{ diff_stats.size_distribution.small }}</span>
                                                <br><small class="text-success">{{ diff_stats.size_percentages.small }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Medium Card -->
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <div class="d-flex justify-content-between align-items-end p-2 bg-primary-subtle rounded"
                                             style="min-height: {{ 60 + (diff_stats.size_percentages.medium|default(0) * 2) }}px;">
                                            <div>
                                                <strong class="text-primary">Medium</strong>
                                                <br><small class="text-muted">51-300 lines</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-primary">{{ diff_stats.size_distribution.medium }}</span>
                                                <br><small class="text-primary">{{ diff_stats.size_percentages.medium }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Large Card -->
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <div class="d-flex justify-content-between align-items-end p-2 bg-warning-subtle rounded"
                                             style="min-height: {{ 60 + (diff_stats.size_percentages.large|default(0) * 2) }}px;">
                                            <div>
                                                <strong class="text-warning">Large</strong>
                                                <br><small class="text-muted">301-1000 lines</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-warning">{{ diff_stats.size_distribution.large }}</span>
                                                <br><small class="text-warning">{{ diff_stats.size_percentages.large }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Huge Card -->
                                    <div class="col-lg-3 col-md-6 mb-2">
                                        <div class="d-flex justify-content-between align-items-end p-2 bg-danger-subtle rounded"
                                             style="min-height: {{ 60 + (diff_stats.size_percentages.huge|default(0) * 2) }}px;">
                                            <div>
                                                <strong class="text-danger">Huge</strong>
                                                <br><small class="text-muted">1000+ lines</small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-danger">{{ diff_stats.size_distribution.huge }}</span>
                                                <br><small class="text-danger">{{ diff_stats.size_percentages.huge }}%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Top PRs/MRs Tabs -->
                        <div class="row">
                            <div class="col-12">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-trophy me-1"></i>Top Contributing PRs/MRs (All Users)
                                </h6>
                                <ul class="nav nav-tabs" id="allDataTopPRTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="alldata-additions-tab" data-bs-toggle="tab"
                                                data-bs-target="#alldata-additions-pane" type="button" role="tab">
                                            <i class="bi bi-plus-circle text-success me-1"></i>Most Additions
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="alldata-deletions-tab" data-bs-toggle="tab"
                                                data-bs-target="#alldata-deletions-pane" type="button" role="tab">
                                            <i class="bi bi-dash-circle text-danger me-1"></i>Most Deletions
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="alldata-total-tab" data-bs-toggle="tab"
                                                data-bs-target="#alldata-total-pane" type="button" role="tab">
                                            <i class="bi bi-graph-up text-primary me-1"></i>Largest Changes
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="alldata-files-tab" data-bs-toggle="tab"
                                                data-bs-target="#alldata-files-pane" type="button" role="tab">
                                            <i class="bi bi-files text-info me-1"></i>Most Files
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content mt-3" id="allDataTopPRTabContent">
                                    <!-- Most Additions -->
                                    <div class="tab-pane fade show active" id="alldata-additions-pane" role="tabpanel">
                                        {% if diff_stats.top_by_additions %}
                                            {% for pr in diff_stats.top_by_additions[:5] %}
                                            <div class="d-flex justify-content-between align-items-start p-2 border-bottom">
                                                <div class="flex-grow-1 me-2">
                                                    <a href="{{ pr.html_url }}" target="_blank" class="text-decoration-none">
                                                        <strong>{{ pr.title[:80] }}{% if pr.title|length > 80 %}...{% endif %}</strong>
                                                    </a>
                                                    <br><small class="text-muted">{{ pr.source }} • {{ pr.repo_name }} • by {{ pr.user_login }}</small>
                                                </div>
                                                <div class="text-end text-nowrap">
                                                    <span class="badge bg-success">+{{ '{:,}'.format(pr.additions) }}</span>
                                                    <br><small class="text-muted">-{{ pr.deletions }} • {{ pr.changed_files }} files</small>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No additions data available</p>
                                        {% endif %}
                                    </div>

                                    <!-- Most Deletions -->
                                    <div class="tab-pane fade" id="alldata-deletions-pane" role="tabpanel">
                                        {% if diff_stats.top_by_deletions %}
                                            {% for pr in diff_stats.top_by_deletions[:5] %}
                                            <div class="d-flex justify-content-between align-items-start p-2 border-bottom">
                                                <div class="flex-grow-1 me-2">
                                                    <a href="{{ pr.html_url }}" target="_blank" class="text-decoration-none">
                                                        <strong>{{ pr.title[:80] }}{% if pr.title|length > 80 %}...{% endif %}</strong>
                                                    </a>
                                                    <br><small class="text-muted">{{ pr.source }} • {{ pr.repo_name }} • by {{ pr.user_login }}</small>
                                                </div>
                                                <div class="text-end text-nowrap">
                                                    <span class="badge bg-danger">-{{ '{:,}'.format(pr.deletions) }}</span>
                                                    <br><small class="text-muted">+{{ pr.additions }} • {{ pr.changed_files }} files</small>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No deletions data available</p>
                                        {% endif %}
                                    </div>

                                    <!-- Largest Total Changes -->
                                    <div class="tab-pane fade" id="alldata-total-pane" role="tabpanel">
                                        {% if diff_stats.top_by_total_changes %}
                                            {% for pr in diff_stats.top_by_total_changes[:5] %}
                                            <div class="d-flex justify-content-between align-items-start p-2 border-bottom">
                                                <div class="flex-grow-1 me-2">
                                                    <a href="{{ pr.html_url }}" target="_blank" class="text-decoration-none">
                                                        <strong>{{ pr.title[:80] }}{% if pr.title|length > 80 %}...{% endif %}</strong>
                                                    </a>
                                                    <br><small class="text-muted">{{ pr.source }} • {{ pr.repo_name }} • by {{ pr.user_login }}</small>
                                                </div>
                                                <div class="text-end text-nowrap">
                                                    <span class="badge bg-primary">{{ '{:,}'.format(pr.total_changes) }} total</span>
                                                    <br><small class="text-success">+{{ pr.additions }}</small> <small class="text-danger">-{{ pr.deletions }}</small> • <small class="text-muted">{{ pr.changed_files }} files</small>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No total changes data available</p>
                                        {% endif %}
                                    </div>

                                    <!-- Most Files Changed -->
                                    <div class="tab-pane fade" id="alldata-files-pane" role="tabpanel">
                                        {% if diff_stats.top_by_files %}
                                            {% for pr in diff_stats.top_by_files[:5] %}
                                            <div class="d-flex justify-content-between align-items-start p-2 border-bottom">
                                                <div class="flex-grow-1 me-2">
                                                    <a href="{{ pr.html_url }}" target="_blank" class="text-decoration-none">
                                                        <strong>{{ pr.title[:80] }}{% if pr.title|length > 80 %}...{% endif %}</strong>
                                                    </a>
                                                    <br><small class="text-muted">{{ pr.source }} • {{ pr.repo_name }} • by {{ pr.user_login }}</small>
                                                </div>
                                                <div class="text-end text-nowrap">
                                                    <span class="badge bg-info">{{ pr.changed_files }} files</span>
                                                    <br><small class="text-success">+{{ pr.additions }}</small> <small class="text-danger">-{{ pr.deletions }}</small>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No files data available</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if overall_stats.github_total_prs == 0 and overall_stats.gitlab_total_mrs == 0 and overall_stats.app_interface_total_mrs == 0 %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>No activity found in this date range.</strong>
            Try expanding the date range or ensure your data sources are up to date.
        </div>
    {% endif %}
</div>

<!-- Configuration Modal -->
{% include 'modals/user_config_modal.html' %}

{% block js %}
    <script src="{{ url_for('static', filename='js/components/filters/date_range_filter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pages/personal_stats.js') }}"></script>
    <script src="{{ url_for('static', filename='js/pages/all_data_stats.js') }}"></script>
{% endblock %}
{% endblock %}
