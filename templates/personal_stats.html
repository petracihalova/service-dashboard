{% extends "layout.html" %}

{% block title %}Personal Statistics{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/personal_stats.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mt-2">Personal Statistics </h1>
    </div>

    <!-- Date Range Filter & Tracked Identities Row -->
    <div class="row mb-4">
        <!-- Date Range Filter -->
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 text-muted">
                        <i class="bi bi-calendar-range me-1"></i>Date Range
                    </h6>
                    <form method="GET" class="d-flex flex-wrap align-items-end gap-3">
                        <div>
                            <label for="date-from-input" class="form-label small">From</label>
                            <input type="date" class="form-control form-control-sm" id="date-from-input"
                                   name="date_from" value="{{ from_date }}">
                        </div>
                        <div>
                            <label for="date-to-input" class="form-label small">To</label>
                            <input type="date" class="form-control form-control-sm" id="date-to-input"
                                   name="date_to" value="{{ to_date }}">
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary btn-sm" id="apply-date-range">
                                <i class="bi bi-funnel me-1"></i>Apply Filter
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-danger btn-sm" id="reset-filters">
                                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
                            </button>
                        </div>
                    </form>

                    <!-- Quarter and Year Presets -->
                    <div class="mt-3">
                        <div class="mb-2">
                            <small class="text-muted">Quick Selection:</small>
                        </div>

                        <!-- 2024 Row: Quarters + Year -->
                        <div class="d-flex flex-wrap gap-1 mb-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2024-01-01" data-to="2024-03-31">Q1 2024</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2024-04-01" data-to="2024-06-30">Q2 2024</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2024-07-01" data-to="2024-09-30">Q3 2024</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2024-10-01" data-to="2024-12-31">Q4 2024</button>
                            <button type="button" class="btn btn-outline-primary btn-sm year-btn"
                                    data-from="2024-01-01" data-to="2024-12-31">
                                <i class="bi bi-calendar4 me-1"></i>2024
                            </button>
                        </div>

                        <!-- 2025 Row: Quarters + Year -->
                        <div class="d-flex flex-wrap gap-1">
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2025-01-01" data-to="2025-03-31">Q1 2025</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2025-04-01" data-to="2025-06-30">Q2 2025</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2025-07-01" data-to="2025-09-30">Q3 2025</button>
                            <button type="button" class="btn btn-outline-secondary btn-sm quarter-btn"
                                    data-from="2025-10-01" data-to="2025-12-31">Q4 2025</button>
                            <button type="button" class="btn btn-outline-primary btn-sm year-btn"
                                    data-from="2025-01-01" data-to="2025-12-31">
                                <i class="bi bi-calendar4 me-1"></i>2025
                            </button>
                        </div>
                    </div>

                    <div class="mt-2">
                        <small class="fw-semibold" id="date-range-info">
                            Showing data for {{ from_date }} to {{ to_date }}
                            ({{ ((to_date | to_date) - (from_date | to_date)).days + 1 }} days)
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Identity Overview -->
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <h6 class="card-subtitle mb-3 text-muted">
                        <i class="bi bi-person-circle me-1"></i>Tracked Identities
                    </h6>
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-github me-2" style="font-size: 1.1rem;"></i>
                            <div>
                                <strong>GitHub:</strong>
                                <span class="text-muted ms-1">{{ github_username or 'Not configured' }}</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-gitlab me-2" style="font-size: 1.1rem; color: #FC6D26;"></i>
                            <div>
                                <strong>GitLab + App-interface:</strong>
                                <span class="text-muted ms-1">{{ gitlab_username or 'Not configured' }}</span>
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="bi bi-ticket me-2 text-primary" style="font-size: 1.1rem;"></i>
                            <div>
                                <strong>JIRA:</strong>
                                <span class="text-muted ms-1">
                                    {% if jira_user and jira_user not in ["Not available", "Unable to fetch user info", ""] %}
                                        {{ jira_user }}
                                    {% else %}
                                        Not configured
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary-subtle border-primary">
                <div class="card-body text-center">
                    <i class="bi bi-git text-primary" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-1 text-primary">{{ overall_stats.total_prs }}</h3>
                    <p class="text-muted mb-0">Total PRs/MRs Merged</p>
                    <small class="text-muted">GitHub + GitLab + App-interface</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success-subtle border-success">
                <div class="card-body text-center">
                    <i class="bi bi-ticket-fill text-success" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-1 text-success">{{ overall_stats.jira_tickets_closed }}</h3>
                    <p class="text-muted mb-0">JIRA Tickets Closed</p>
                    <small class="text-muted">Assigned to you</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-info-subtle border-info">
                <div class="card-body text-center">
                    <i class="bi bi-collection text-info" style="font-size: 2rem;"></i>
                    <h3 class="mt-2 mb-1 text-info">{{ overall_stats.total_repos }}</h3>
                    <p class="text-muted mb-0">Repositories</p>
                    <small class="text-muted">Contributed to</small>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning-subtle border-warning">
                <div class="card-body text-center">
                    <i class="bi bi-star-fill text-warning" style="font-size: 2rem;"></i>
                    <h4 class="mt-2 mb-1 text-warning" style="font-size: 1.1rem;">{{ overall_stats.most_active_repo }}</h4>
                    <p class="text-muted mb-0">Most Active Repo</p>
                    <small class="text-muted">Contributions</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Breakdown -->
    <div class="row">
        <!-- GitHub Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-github me-2"></i>GitHub Activity
                    </h6>
                </div>
                <div class="card-body">
                    {% if github_username %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>PRs Merged:</span>
                            <strong>{{ github_stats.merged_prs_count }}</strong>
                        </div>

                        <!-- Personal Repositories -->
                        {% if github_stats.personal_repos %}
                            <div class="mb-3">
                                <p class="small text-muted mb-2">Personal repositories:</p>
                                {% for repo in github_stats.personal_repos %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span>{{ repo }}</span>
                                        <small class="text-muted">{{ github_stats.personal_repo_stats.get(repo, 0) }} PRs</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Organization Repositories -->
                        {% if github_stats.organization_stats %}
                            <div class="mb-3">
                                <p class="small text-muted mb-2">Organizations:</p>
                                {% for org_name, org_data in github_stats.organization_stats.items() %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <strong>{{ org_name }}</strong>
                                            <small class="text-muted">{{ org_data.pr_count }} PRs total</small>
                                        </div>
                                        <div class="ms-2">
                                            {% for repo in org_data.repos %}
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span>{{ repo }}</span>
                                                    <small class="text-muted">{{ org_data.repo_stats.get(repo, 0) }} PRs</small>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if github_stats.merged_prs_count == 0 %}
                            <p class="text-muted small">No merged PRs in this date range</p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            GitHub username not configured
                        </p>
                        <small class="text-muted">Set GITHUB_USERNAME environment variable</small>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- GitLab Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-gitlab me-2" style="color: #FC6D26;"></i>GitLab + App-interface Activity
                    </h6>
                </div>
                <div class="card-body">
                    {% if gitlab_username %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>MRs Merged:</span>
                            <strong>{{ gitlab_stats.merged_prs_count }}</strong>
                        </div>

                        <!-- Personal Repositories -->
                        {% if gitlab_stats.personal_repos %}
                            <div class="mb-3">
                                <p class="small text-muted mb-2">Personal repositories:</p>
                                {% for repo in gitlab_stats.personal_repos %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span>{{ repo }}</span>
                                        <small class="text-muted">{{ gitlab_stats.personal_repo_stats.get(repo, 0) }} MRs</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Organization Repositories -->
                        {% if gitlab_stats.organization_stats %}
                            <div class="mb-3">
                                <p class="small text-muted mb-2">Organizations:</p>
                                {% for org_name, org_data in gitlab_stats.organization_stats.items() %}
                                    <div class="mb-2">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <strong>{{ org_name }}</strong>
                                            <small class="text-muted">{{ org_data.pr_count }} MRs total</small>
                                        </div>
                                        <div class="ms-2">
                                            {% for repo in org_data.repos %}
                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                    <span>{{ repo }}</span>
                                                    <small class="text-muted">{{ org_data.repo_stats.get(repo, 0) }} MRs</small>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if gitlab_stats.merged_prs_count == 0 %}
                            <p class="text-muted small">No merged MRs in this date range</p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            GitLab username not configured
                        </p>
                        <small class="text-muted">Set GITLAB_USERNAME environment variable</small>
                    {% endif %}
                </div>
            </div>
        </div>



        <!-- JIRA Stats -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-ticket me-2 text-primary"></i>JIRA Activity
                    </h6>
                </div>
                <div class="card-body">
                    {% if jira_user and jira_user not in ["Not available", "Unable to fetch user info"] %}
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Tickets Closed:</span>
                            <strong>{{ jira_stats.closed_tickets_count }}</strong>
                        </div>

                        <!-- Tickets by Type -->
                        {% if jira_stats.tickets_by_type %}
                            <div class="mb-3">
                                <p class="small text-muted mb-2">By issue type:</p>
                                {% for issue_type in jira_stats.issue_types %}
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span>{{ issue_type }}</span>
                                        <small class="text-muted">{{ jira_stats.tickets_by_type[issue_type]|length }} tickets</small>
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if jira_stats.closed_tickets_count == 0 %}
                            <p class="text-muted small">No closed tickets in this date range</p>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">
                            <i class="bi bi-exclamation-circle me-1"></i>
                            JIRA user not available
                        </p>
                        <small class="text-muted">Configure JIRA_PERSONAL_ACCESS_TOKEN</small>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if overall_stats.total_prs == 0 and overall_stats.jira_tickets_closed == 0 %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>No activity found in this date range.</strong>
            Try expanding the date range or ensure your data sources are up to date.
        </div>
    {% endif %}
</div>

{% block js %}
<script src="{{ url_for('static', filename='js/personal_stats.js') }}"></script>
{% endblock %}
{% endblock %}
